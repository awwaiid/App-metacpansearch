#!/usr/bin/env perl

use strict;
use LWP::Simple;
use JSON;
use Getopt::Std;

sub HELP_MESSAGE {
  print q|

cpans [-q] SearchTerms

Uses the metacpan API to do a search!

-q        Quiet down a bit, no abstract
--help    This

|;
}

my $opts = {};

getopts('q', $opts);

# Everything else is part of the search
my $search = "@ARGV";

my $r = decode_json(
  get "http://api.metacpan.org/v0/release/_search?q=status:latest AND $search"
);

foreach my $hit (@{$r->{hits}->{hits}}) {
  my $dist = $hit->{_source}->{distribution};
  $dist =~ s/-/::/g;

  if($opts->{q}) {
    print "$dist\n";
  } else {
    print "$dist - $hit->{_source}->{abstract}\n"
  }
}

